<!DOCTYPE html>
<html>
<head>
  <title>Stocklist Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .stocklist-details {
      margin-top: 20px;
    }
    .stock-table, .performance-table, .prediction-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .stock-table th, .stock-table td, .performance-table th, .performance-table td, .prediction-table th, .prediction-table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    .stock-table th, .performance-table th, .prediction-table th {
      background-color: #f4f4f4;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
  <h1 id="stocklist-name">Stocklist Page</h1>
  <div class="stocklist-details">
    <p><strong>Name:</strong> <span id="stocklist-name-detail"></span></p>
    <p><strong>Visibility:</strong></p>
    <input type="radio" id="public" name="visibility" value="Public" disabled>
    <label for="public">Public</label>
    <input type="radio" id="private" name="visibility" value="Private" disabled>
    <label for="private">Private</label>
    <p><strong>Total Stocklist Value:</strong> <span id="stocklist-value"></span></p>
  </div>
  <table class="stock-table" id="stock-table">
    <thead>
      <tr>
        <th>Stock Symbol</th>
        <th>Number of Shares</th>
        <th>Most Recent Close Price (per share)</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <h2>Stocklist Performance Over Time</h2>
  <canvas id="performance-chart"></canvas>

  <h2>Stocklist Past Performance</h2>
  <table class="performance-table">
    <thead>
      <tr>
        <th>Month</th>
        <th>Stocklist Value</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Predicted Stocklist Value Over the Next 5 Years</h2>
  <canvas id="prediction-chart"></canvas>

  <h2>Predicted Stocklist Value</h2>
  <table class="prediction-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Predicted Value</th>
      </tr>
    </thead>
    <tbody id="prediction-body"></tbody>
  </table>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const stocklistId = urlParams.get('id');
      let performanceChart, predictionChart;

      if (stocklistId) {
        fetch(`/api/stocklist/${stocklistId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              document.getElementById('stocklist-name').textContent = data.name || 'Unnamed Stocklist';
              document.getElementById('stocklist-name-detail').textContent = data.name || 'N/A';
              if (data.ispublic) {
                document.getElementById('public').checked = true;
              } else {
                document.getElementById('private').checked = true;
              }
              fetch('/api/session')
                .then(response => response.json())
                .then(sessionData => {
                  if (sessionData.user.email === data.owner) {
                    document.getElementById('public').disabled = false;
                    document.getElementById('private').disabled = false;
                    document.querySelectorAll('input[name="visibility"]').forEach(radio => {
                      radio.addEventListener('change', function() {
                        const selectedVisibility = this.value === 'Public';
                        fetch(`/api/stocklist/${stocklistId}/visibility`, {
                          method: 'PUT',
                          headers: {
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({ isPublic: selectedVisibility })
                        })
                        .then(response => {
                          if (!response.ok) {
                            throw new Error('Network response was not ok');
                          }
                          return response.json();
                        })
                        .then(updateData => {
                          console.log('Visibility updated successfully:', updateData);
                        })
                        .catch(error => console.error('Error updating visibility:', error));
                      });
                    });
                  }
                })
                .catch(error => console.error('Error fetching session data:', error));
              fetch(`/api/stocklist/${stocklistId}/stocks`)
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  return response.json();
                })
                .then(stockData => {
                  const stockTableBody = document.getElementById('stock-table').querySelector('tbody');
                  let totalValue = 0;

                  stockData.forEach(stock => {
                    const row = document.createElement('tr');
                    const stockSymbolCell = document.createElement('td');
                    stockSymbolCell.textContent = stock.stocksymbol;
                    const numSharesCell = document.createElement('td');
                    numSharesCell.textContent = stock.numshares;
                    const closePriceCell = document.createElement('td');
                    closePriceCell.textContent = stock.close || 'N/A';

                    const stockValue = stock.numshares * stock.close;
                    totalValue += stockValue;

                    row.appendChild(stockSymbolCell);
                    row.appendChild(numSharesCell);
                    row.appendChild(closePriceCell);
                    stockTableBody.appendChild(row);
                  });

                  document.getElementById('stocklist-value').textContent = totalValue.toFixed(2);

                  fetchPerformanceData(stocklistId, stockData);
                  fetchPredictionData(stocklistId);
                })
                .catch(error => console.error('Error fetching stock data:', error));
            } else {
              console.error('No data returned for stocklist details.');
            }
          })
          .catch(error => console.error('Error fetching stocklist details:', error));
      } else {
        console.error('No stocklist ID found in the URL.');
      }

      function fetchPerformanceData(stocklistId, stockData) {
        const performanceTableBody = document.querySelector('.performance-table tbody');
        performanceTableBody.innerHTML = '';

        const promises = stockData.map(stock => {
          return fetch(`/api/stock-history/${stock.stocksymbol}`)
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              const monthlyData = groupByMonth(data);
              return { stock, monthlyData };
            });
        });

        Promise.all(promises)
          .then(results => {
            const stocklistHistory = {};

            results.forEach(({ stock, monthlyData }) => {
              Object.keys(monthlyData).forEach(month => {
                if (!stocklistHistory[month]) {
                  stocklistHistory[month] = 0;
                }
                stocklistHistory[month] += stock.numshares * monthlyData[month].close;
              });
            });

            const months = Object.keys(stocklistHistory).sort();
            const stocklistValues = months.map(month => stocklistHistory[month]);

            const ctx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: months,
                datasets: [{
                  label: 'Stocklist Value',
                  data: stocklistValues,
                  borderColor: 'rgba(54, 162, 235, 1)',
                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'month',
                      tooltipFormat: 'MMM yyyy',
                      displayFormats: {
                        month: 'MMM yyyy'
                      }
                    }
                  },
                  y: {
                    beginAtZero: false
                  }
                }
              }
            });

            months.forEach(month => {
              const row = document.createElement('tr');
              const monthCell = document.createElement('td');
              monthCell.textContent = month;
              const valueCell = document.createElement('td');
              valueCell.textContent = stocklistHistory[month].toFixed(2);
              row.appendChild(monthCell);
              row.appendChild(valueCell);
              performanceTableBody.appendChild(row);
            });
          })
          .catch(error => console.error('Error fetching performance data:', error));
      }

      function groupByMonth(data) {
        return data.reduce((acc, item) => {
          const date = new Date(item.timestamp);
          const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!acc[month]) {
            acc[month] = item;
          }
          return acc;
        }, {});
      }

      function fetchPredictionData(stocklistId) {
        fetch(`/api/predicted-stocklist/${stocklistId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(predictions => {
            const predictionTableBody = document.getElementById('prediction-body');
            predictionTableBody.innerHTML = '';

            const dates = predictions.map(prediction => prediction.date);
            const values = predictions.map(prediction => prediction.predictedValue);

            const ctx = document.getElementById('prediction-chart').getContext('2d');
            predictionChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: dates,
                datasets: [{
                  label: 'Predicted Stocklist Value',
                  data: values,
                  borderColor: 'rgba(255, 99, 132, 1)',
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'month',
                      tooltipFormat: 'MMM yyyy',
                      displayFormats: {
                        month: 'MMM yyyy'
                      }
                    }
                  },
                  y: {
                    beginAtZero: false
                  }
                }
              }
            });

            predictions.forEach(prediction => {
              const row = document.createElement('tr');
              const dateCell = document.createElement('td');
              dateCell.textContent = prediction.date;
              const valueCell = document.createElement('td');
              valueCell.textContent = prediction.predictedValue.toFixed(2);
              row.appendChild(dateCell);
              row.appendChild(valueCell);
              predictionTableBody.appendChild(row);
            });
          })
          .catch(error => console.error('Error fetching prediction data:', error));
      }
    });
  </script>
</body>
</html>
