<!DOCTYPE html>
<html>
<head>
  <title>Stocklist Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .stocklist-details {
      margin-top: 20px;
    }
    .stock-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .stock-table th, .stock-table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    .stock-table th {
      background-color: #f4f4f4;
    }
    a {
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <h1 id="stocklist-name">Stocklist Page</h1>
  <div class="stocklist-details">
    <p><strong>Name:</strong> <span id="stocklist-name-detail"></span></p>
    <p><strong>Visibility:</strong></p>
    <input type="radio" id="public" name="visibility" value="Public" disabled>
    <label for="public">Public</label>
    <input type="radio" id="private" name="visibility" value="Private" disabled>
    <label for="private">Private</label>
    <p><strong>Total Stocklist Value:</strong> <span id="stocklist-value"></span></p>
  </div>
  <table class="stock-table" id="stock-table">
    <thead>
      <tr>
        <th>Stock Symbol</th>
        <th>Number of Shares</th>
        <th>Most Recent Close Price (per share)</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <div class="section form-section" style="display: none;">
    <h2>Request a Review on this Stocklist</h2>
    <form action="/request-review" method="post">
      <input type="email" 
      name="userEmail" 
      placeholder="User's Email" 
      required id="review-request-input" />
      <input type="hidden" name="stocklistid" id="stocklist-id-input" />
      <button type="button" id="request-review-button">Request Review</button>
    </form>
  </div>  

  <div class="section reviews" style="display: block;">
    <h2>Reviews on this Stocklist</h2>
    <ul id="stocklist-reviews"></ul>
  </div>

  <div class="section add-review" style="display: none;">
    <h2>Add a review</h2>
    <button type="button" id="add-review-button">Add Review</button>
    <form id="add-review-form" style="display: none;">
      <label for="review-text">Review:</label>
      <textarea id="review-text" name="review-text" required></textarea>
      <button type="submit">Submit</button>
    </form>
  </div>

  <a href="/dashboard">Back to Dashboard</a>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const stocklistid = urlParams.get('id');

      fetchStocklistReviews(stocklistid);

      const addReviewButton = document.getElementById("add-review-button");
      const addReviewForm = document.getElementById("add-review-form");

      addReviewButton.addEventListener("click", () => {
        addReviewForm.style.display = "block";
      });

      addReviewForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const reviewtext = document.getElementById("review-text").value;

        // Assuming you have an API endpoint to handle the review submission
        fetch("/api/add-review", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ stocklistid, reviewtext })
        })
        .then(response => {
          if (!response.ok) { // Check if the response status is not OK (200-299)
            return response.json().then(data => {
              throw new Error(data.error); // Throw an error with the error message
            });
          }
          return response.json();
        })
        .then(data => {
          alert("Review added successfully!"); // Display success message only if there is no error
          addReviewForm.reset();
          addReviewForm.style.display = "none";
          fetchStocklistReviews(stocklistid);
        })
        .catch(err => {
          alert(err.message); // Alert the error message
        });
      });

      if (stocklistid) {
        fetch(`/api/stocklist/${stocklistid}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              document.getElementById('stocklist-name').textContent = data.name || 'Unnamed Stocklist';
              document.getElementById('stocklist-name-detail').textContent = data.name || 'N/A';
              if (data.ispublic) {
                  document.getElementById('public').checked = true;
                  const formSections = document.getElementsByClassName('add-review');
                  for (let i = 0; i < formSections.length; i++) {
                      formSections[i].style.display = 'block';
                  }
              } else {
                  document.getElementById('private').checked = true;
                  const formSections = document.getElementsByClassName('form-section');
                  for (let i = 0; i < formSections.length; i++) {
                      formSections[i].style.display = 'block';
                  }
                  // if the user is not the owner of the stocklist, set the dispaly of section reviews to none:
                  fetch('/api/session')
                    .then(response => response.json())
                    .then(sessionData => {
                      if (sessionData.user.email !== data.owner) {
                        const reviewsSection = document.getElementsByClassName('reviews');
                        for (let i = 0; i < reviewsSection.length; i++) {
                            reviewsSection[i].style.display = 'none';
                        }
                        const formSections = document.getElementsByClassName('add-review');
                        for (let i = 0; i < formSections.length; i++) {
                            formSections[i].style.display = 'block';
                        }
                      }
                    })
                    .catch(error => console.error('Error fetching session data:', error));
              }
              fetch('/api/session')
                .then(response => response.json())
                .then(sessionData => {
                  if (sessionData.user.email === data.owner) {
                    document.getElementById('public').disabled = false;
                    document.getElementById('private').disabled = false;
                    document.querySelectorAll('input[name="visibility"]').forEach(radio => {
                      radio.addEventListener('change', function() {
                        const selectedVisibility = this.value === 'Public';
                        fetch(`/api/stocklist/${stocklistid}/visibility`, {
                          method: 'PUT',
                          headers: {
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({ isPublic: selectedVisibility })
                        })
                        .then(response => {
                          if (!response.ok) {
                            throw new Error('Network response was not ok');
                          }
                          return response.json();
                        })
                        .then(updateData => {
                          console.log('Visibility updated successfully:', updateData);
                        })
                        .catch(error => console.error('Error updating visibility:', error));
                      });
                    });
                  }
                })
                .catch(error => console.error('Error fetching session data:', error));
              fetch(`/api/stocklist/${stocklistid}/stocks`)
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  return response.json();
                })
                .then(stockData => {
                  const stockTableBody = document.getElementById('stock-table').querySelector('tbody');
                  let totalValue = 0;

                  stockData.forEach(stock => {
                    const row = document.createElement('tr');
                    const stockSymbolCell = document.createElement('td');
                    stockSymbolCell.textContent = stock.stocksymbol;
                    const numSharesCell = document.createElement('td');
                    numSharesCell.textContent = stock.numshares;
                    const closePriceCell = document.createElement('td');
                    closePriceCell.textContent = stock.close || 'N/A';

                    const stockValue = stock.numshares * stock.close;
                    totalValue += stockValue;

                    row.appendChild(stockSymbolCell);
                    row.appendChild(numSharesCell);
                    row.appendChild(closePriceCell);
                    stockTableBody.appendChild(row);
                  });

                  document.getElementById('stocklist-value').textContent = totalValue.toFixed(2);
                })
                .catch(error => console.error('Error fetching stock data:', error));
            } else {
              console.error('No data returned for stocklist details.');
            }


            // fetch(`/api/reviews?stocklistid=${stocklistid}`)
            //   .then(response => response.json())
            //   .then(reviews => {
            //     const reviewsList = document.getElementById('stocklist-reviews');
            //     reviews.forEach(review => {
            //       const li = document.createElement('li');
            //       li.textContent = `${review.email}: ${review.reviewText}`;
            //       reviewsList.appendChild(li);
            //     });
            //   })
            //   .catch(error => console.error('Error fetching reviews:', error));
          })
          .catch(error => console.error('Error fetching stocklist details:', error));

          


          // Add friend request functionality
          const reviewRequestInput = document.getElementById('review-request-input');
          const sendRequestButton = document.getElementById('request-review-button');

          sendRequestButton.addEventListener('click', () => {
            const email = reviewRequestInput.value.trim();
            if (email) {
              console.log('Sending review request to:', email);
              sendReviewRequest(email, stocklistid);
              reviewRequestInput.value = '';
            }
          });
      } else {
        console.error('No stocklist ID found in the URL.');
      }
    });


    function sendReviewRequest(email, stocklistid) {
        fetch('/api/request-review', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: email, stocklistid: stocklistid, reviewText: "" })
        })
        .then(response => response.json())
        .then(data => {
          console.log('Review request sent:', data);
          alert('Review request sent successfully');
        })
        .catch(error => console.error('Error sending review request:', error));
      }

      function fetchStocklistReviews(stocklistid) {
        fetch("/api/stocklist-reviews", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ stocklistid: stocklistid }),
        })
          .then((response) => response.json())
          .then((data) => {
            const reviewsList = document.getElementById("stocklist-reviews");
            reviewsList.innerHTML = ""; // Clear any existing list items

            if (data.reviews.length === 0) {
              reviewsList.textContent = "No reviews found for this stocklist.";
            } else {
              data.reviews.forEach((review) => {
                const listItem = document.createElement("li");
                if (review.reviewtext !== "") {
                  listItem.textContent = `Review from ${review.name}: "${review.reviewtext}"`;
                  reviewsList.appendChild(listItem);
                  console.log("Review: " + review.reviewtext);
                } else {
                  listItem.textContent = `Review from ${review.name}: Pending...`;
                  reviewsList.appendChild(listItem);
                  console.log("Review: Pending...");
                }
              });
            }
          })
          .catch((error) =>
            console.error("Error fetching stocklist reviews:", error)
          );
      }
  </script>
</body>
</html>
