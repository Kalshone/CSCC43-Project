<!DOCTYPE html>
<html>
<head>
  <title>Portfolio Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .portfolio-details, .stocklist-details {
      margin-top: 20px;
    }
    .stock-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .stock-table th, .stock-table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    .stock-table th {
      background-color: #f4f4f4;
    }
    .add-cash {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1 id="portfolio-name">Portfolio Page</h1>
  <div class="portfolio-details">
    <p><strong>ID:</strong> <span id="portfolio-id"></span></p>
    <p><strong>Name:</strong> <span id="portfolio-name-detail"></span></p>
    <p><strong>Stock List ID:</strong> <span id="stock-list-id"></span></p>
    <p><strong>Cash Balance:</strong> <span id="cash-balance"></span></p>
  </div>

  <div class="add-cash">
    <h3>Add Cash to Portfolio</h3>
    <input type="number" id="cash-amount" placeholder="Enter amount">
    <button id="add-cash-button">Add</button>
  </div>

  <div class="stocklist-details">
    <h3>Stocks in this Stocklist</h3>
    <table class="stock-table" id="stock-table">
      <thead>
        <tr>
          <th>Stock Symbol</th>
          <th>Number of Shares</th>
          <th>Most Recent Close Price</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const portfolioId = urlParams.get('id');

      if (portfolioId) {
        fetch(`/api/portfolio/${portfolioId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              document.getElementById('portfolio-name').textContent = data.name || 'Unnamed Portfolio';
              document.getElementById('portfolio-id').textContent = data.portfolioid || 'N/A';
              document.getElementById('portfolio-name-detail').textContent = data.name || 'N/A';
              document.getElementById('stock-list-id').textContent = data.stocklistid || 'N/A';
              document.getElementById('cash-balance').textContent = data.cashbalance || 'N/A';

              if (data.stocklistid) {
                fetch(`/api/stocklist/${data.stocklistid}/stocks`)
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json();
                  })
                  .then(stockData => {
                    const stockTableBody = document.getElementById('stock-table').querySelector('tbody');
                    stockData.forEach(stock => {
                      const row = document.createElement('tr');
                      const stockSymbolCell = document.createElement('td');
                      stockSymbolCell.textContent = stock.stocksymbol;
                      const numSharesCell = document.createElement('td');
                      numSharesCell.textContent = stock.numshares;
                      const closePriceCell = document.createElement('td');
                      closePriceCell.textContent = stock.close || 'N/A';
                      row.appendChild(stockSymbolCell);
                      row.appendChild(numSharesCell);
                      row.appendChild(closePriceCell);
                      stockTableBody.appendChild(row);
                    });
                  })
                  .catch(error => console.error('Error fetching stock data:', error));
              }
            } else {
              console.error('No data returned for portfolio details.');
            }
          })
          .catch(error => console.error('Error fetching portfolio details:', error));
      } else {
        console.error('No portfolio ID found in the URL.');
      }

      document.getElementById('add-cash-button').addEventListener('click', function() {
        const cashAmountInput = document.getElementById('cash-amount');
        const cashAmount = parseFloat(cashAmountInput.value);
        if (!isNaN(cashAmount) && cashAmount > 0) {
          fetch(`/api/portfolio/${portfolioId}/add-cash`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ amount: cashAmount })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            console.log('Cash added successfully:', data);
            document.getElementById('cash-balance').textContent = data.newCashBalance;
            cashAmountInput.value = '';
          })
          .catch(error => console.error('Error adding cash to portfolio:', error));
        } else {
          alert('Please enter a valid cash amount.');
        }
      });
    });
  </script>
</body>
</html>
