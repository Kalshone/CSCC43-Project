<!DOCTYPE html>
<html>
<head>
  <title>Stocks</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .stock-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }
    .stock-item div {
      flex: 1;
    }
    .stock-item input,
    .stock-item select {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Stocks</h1>
  <div id="stock-list"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/api/stocks')
        .then(response => response.json())
        .then(stocks => {
          return Promise.all([
            Promise.resolve(stocks),
            fetch('/api/portfolios').then(response => response.json()),
            fetch('/api/stocklists').then(response => response.json())
          ]);
        })
        .then(([stocks, portfolios, stocklists]) => {
          const stockList = document.getElementById('stock-list');
          const portfolioStocklistIds = portfolios.map(portfolio => portfolio.stocklistid);

          stocks.forEach(stock => {
            const stockItem = document.createElement('div');
            stockItem.classList.add('stock-item');

            const stockCode = document.createElement('div');
            stockCode.textContent = stock.code;

            const stockPrice = document.createElement('div');
            stockPrice.textContent = `Price: ${stock.close}`;

            const sharesInput = document.createElement('input');
            sharesInput.type = 'number';
            sharesInput.placeholder = 'Number of shares';

            const buySelect = document.createElement('select');
            const buyOption = document.createElement('option');
            buyOption.textContent = 'Buy';
            buyOption.disabled = true;
            buyOption.selected = true;
            buySelect.appendChild(buyOption);
            portfolios.forEach(portfolio => {
              const option = document.createElement('option');
              option.value = portfolio.portfolioid;
              option.textContent = portfolio.name;
              buySelect.appendChild(option);
            });

            const addToStocklistSelect = document.createElement('select');
            const addOption = document.createElement('option');
            addOption.textContent = 'Add to Stocklist';
            addOption.disabled = true;
            addOption.selected = true;
            addToStocklistSelect.appendChild(addOption);
            const filteredStocklists = stocklists.filter(stocklist => !portfolioStocklistIds.includes(stocklist.stocklistid));
            filteredStocklists.forEach(stocklist => {
              const option = document.createElement('option');
              option.value = stocklist.stocklistid;
              option.textContent = stocklist.name;
              addToStocklistSelect.appendChild(option);
            });

            addToStocklistSelect.addEventListener('change', () => {
              const stocklistId = addToStocklistSelect.value;
              const numShares = sharesInput.value;

              if (numShares > 0 && stocklistId) {
                fetch('/api/add-to-stocklist', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    stockSymbol: stock.code,
                    numShares: numShares,
                    stocklistId: stocklistId
                  })
                })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    alert('Stock added to stocklist successfully');
                    addToStocklistSelect.selectedIndex = 0;
                    sharesInput.value = '';
                  } else {
                    alert('Error adding stock to stocklist');
                  }
                })
                .catch(error => console.error('Error:', error));
              } else {
                alert('Please enter a valid number of shares and select a stocklist');
              }
            });

            stockItem.appendChild(stockCode);
            stockItem.appendChild(stockPrice);
            stockItem.appendChild(sharesInput);
            stockItem.appendChild(buySelect);
            stockItem.appendChild(addToStocklistSelect);

            stockList.appendChild(stockItem);
          });
        })
        .catch(error => console.error('Error fetching stock data:', error));
    });
  </script>
</body>
</html>
